<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Convert invalid strings into entities &#8211; Aaron Addleman</title>
<meta name="description" content="When scraping content, sometimes a invalid character is contained in the content. In this article, I show some code that I used to convert the invalids into entities using the htmlentities gem package.">
<meta name="keywords" content="ruby, wordpress">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/8160263904_6dd8c8e420_o.jpg">

<meta name="twitter:title" content="Convert invalid strings into entities">
<meta name="twitter:description" content="When scraping content, sometimes a invalid character is contained in the content. In this article, I show some code that I used to convert the invalids into entities using the htmlentities gem package.">
<meta name="twitter:creator" content="@aaronaddleman">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Convert invalid strings into entities">
<meta property="og:description" content="When scraping content, sometimes a invalid character is contained in the content. In this article, I show some code that I used to convert the invalids into entities using the htmlentities gem package.">
<meta property="og:url" content="/articles/convert-invalid-strings-into-entities/">
<meta property="og:site_name" content="Aaron Addleman">





<link rel="canonical" href="/articles/convert-invalid-strings-into-entities/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Aaron Addleman Feed">
<link rel="author" href="aaronaddleman?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/css/uv/eiffel.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Aaron Addleman photo" class="author-photo">
					<h4>Aaron Addleman</h4>
					<p>Nerd and geek with passion for learning and exploring.</p>
				</li>
				<li><a href="/about/">Learn More</a></li>
				<li>
					<a href="mailto:aaronaddleman@gmail.com"><i class="fa fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/aaronaddleman"><i class="fa fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="http://facebook.com/aaronaddleman"><i class="fa fa-facebook"></i> Facebook</a>
				</li>
				<li>
					<a href="aaronaddleman"><i class="fa fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="http://linkedin.com/pub/aaron-addleman/0/428/276"><i class="fa fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/aaronaddleman"><i class="fa fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		<li><a href="/resume">Resume</a></li>
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  <div class="image-credit">Image source: Aaron Addleman</div><!-- /.image-credit -->
  <div class="entry-image">
    <img src="/images/8160263904_6dd8c8e420_o.jpg" alt="Convert invalid strings into entities">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/articles/convert-invalid-strings-into-entities/" rel="bookmark" title="Convert invalid strings into entities">Convert invalid strings into entities</a></h1>
        
        <h2>October 13, 2012</h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~2 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h1 id="convert-invalid-strings-into-entities">Convert invalid strings into entities</h1>

<h1 id="summary">Summary</h1>

<p>While scraping content from a website, I ran into a large problem with content containing invalid characters. These were characters like the “medium-dash”, apostrophe from a Microsoft Word document, and other strange characters (excluding math operations). With my script grabbing the content and putting it into Wordpress, they were all converted into three characters that looked really bad.</p>

<h1 id="solution">Solution</h1>

<h2 id="attempt-1-outcome--okay-but-too-many-variations">Attempt 1 (outcome = okay, but too many variations)</h2>

<p>I tried to use gsub to replace the characters, but this started to get long and out of control and at some point, it stopped to work on the count of I could not target the invalid character.</p>

<h2 id="attempt-2-outcome--not-good">Attempt 2 (outcome = not good)</h2>

<p>Forcing the ruby script to work in UTF-8 only did not help either. This seemed to have no effect by adding the following to the top of my script files:</p>

<pre><code>:::ruby
#!/usr/bin/env ruby -w
# encoding: UTF-8
</code></pre>

<h2 id="attempt-3-outcome--better">Attempt 3 (outcome = better)</h2>

<p>Using ruby string#encode to convert the invalids did work, but it converted some items and others were just deleted. Below is an example of how I used the code:</p>

<pre><code>:::ruby
string.encode Encoding.find('ASCII'), {
  :invalid           =&gt; :replace,  # Replace invalid byte sequences
  :undef             =&gt; :replace,  # Replace anything not defined in ASCII
  :replace           =&gt; '',        # Use a blank for those replacements
  :universal_newline =&gt; true       # Always break lines with \n
}
</code></pre>

<h2 id="attempt-4-outcome--very-good">Attempt 4 (outcome = very good)</h2>

<p>I came across the library called <a href="http://htmlentities.rubyforge.org/" title="Html Entities">htmlentities</a> and with a little testing I found a great combination of what I wanted to do with the scrapped content. First, the code takes the inner html and encodes the invalid characters. Then I use gsub to return some of the entities back into what I would like to use for Wordpress content to uphold the html classes, tags, and design.</p>

<pre><code>:::ruby
require 'htmlentities'

HTMLEntities::new::encode(results.inner_html, :basic, :named, :decimal).gsub("&amp;lt;", "&lt;").gsub("&amp;gt;", "&gt;").gsub("&amp;#10;", "").gsub("&amp;quot;", "\"")
</code></pre>

<p>I might try to use the results.inner_text but this works great for this project.</p>

<h2 id="attempt-5-outcome--better-than-attempt-4">Attempt 5 (outcome = better than attempt 4)</h2>

<p>I finally realized that in the case you have a document that contains entities and characters that should be in entity form, you need to decode the entities first, then encode all of the characters that need to be in entity form.  Not sure why ‘htmlentities’ does not do this automatically, but oh well. Below is an example of what I like to do in my code:</p>

<pre><code>:::ruby
require 'htmlentities'

decoded_value = HTMLEntities::new::decode(value)
HTMLEntities::new::encode(decoded_value, :basic, :named, :decimal).gsub(/\s\s+/, " ").gsub(/&amp;#10;/, "")
</code></pre>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#ruby" title="Pages tagged ruby" class="tag">ruby</a><a href="/tags/#wordpress" title="Pages tagged wordpress" class="tag">wordpress</a></span>
        <span><a href="/articles/convert-invalid-strings-into-entities/" rel="bookmark" title="Convert invalid strings into entities">Convert invalid strings into entities</a> was published on <span class="entry-date date published updated"><time datetime="2012-10-13T00:00:00-07:00">October 13, 2012</time></span></span>
        
        <span class="author vcard"><span class="fn"><a href="/about/" title="About Aaron Addleman">Aaron Addleman</a></span></span>
        <div class="social-share">
          <ul class="socialcount socialcount-small inline-list">
            <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/articles/convert-invalid-strings-into-entities/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
            <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/articles/convert-invalid-strings-into-entities/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
            <li class="googleplus"><a href="https://plus.google.com/share?url=/articles/convert-invalid-strings-into-entities/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
          </ul>
        </div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    
    <div class="read-more">
      
        <div class="read-more-header">
          <a href="/articles/nesta-caching/" class="read-more-btn">Read More</a>
        </div><!-- /.read-more-header -->
        <div class="read-more-content">
          <h3><a href="/articles/welcome-to-jekyll/" title="Welcome to Jekyll!">Welcome to Jekyll!</a></h3>
          <p>You'll find this post in your `_posts` directory - edit this post and re-build (or run with the `-w` switch) to see your changes!To add n...&hellip; <a href="/articles/welcome-to-jekyll/">Continue reading</a></p>
        </div><!-- /.read-more-content -->
      
      <div class="read-more-list">
        
          <div class="list-item">
            <h4><a href="/articles/ruby-interesting-methods/" title="Ruby's 'Interesting methods'">Ruby's 'Interesting methods'</a></h4>
            <span>Published on August 23, 2014</span>
          </div><!-- /.list-item -->
        
          <div class="list-item">
            <h4><a href="/articles/sourcetree-cli/" title="SourceTree cli">SourceTree cli</a></h4>
            <span>Published on July 25, 2014</span>
          </div><!-- /.list-item -->
        
      </div><!-- /.read-more-list -->
      
    </div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2014 Aaron Addleman. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'aaronaddleman'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>	        

</body>
</html>
